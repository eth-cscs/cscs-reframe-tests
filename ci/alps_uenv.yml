---
include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - pull
  - run

variables:
  # MODE: 'f7t-controller'
  WORKSPACE: '$${CI_CACHE_FOLDER}/rfm_workspace'
  JOB_NAME: rfm-$CI_PIPELINE_ID
  FIRECREST_SYSTEM: 'santis'
  CLUSTER_NAME: 'santis'
  UARCH: 'gh200'
# https://github.com/finkandreas/benchpark/blob/develop/.ci/cscs.yml

setup and pull:
  stage: pull
  tags: ["santis-login-baremetal"]
  # tags: ['f7t-runner']
  # tags: ["santis-spack-stack-builder"]
  variables:
    # Valid MODE=('container-runner', 'baremetal', 'f7t-controller')
    MODE: "f7t-controller"  # santis
    # MODE: "baremetal"  # eiger
    GIT_STRATEGY: "fetch"
    # STACK_SYSTEM:     "santis"
    SLURM_PARTITION: "normal"
    # SLURM_CONSTRAINT: "mc"
    F7T_TOKEN_URL: "https://auth.cscs.ch/auth/realms/firecrest-clients/protocol/openid-connect/token"
    F7T_URL: "https://firecrest.cscs.ch"
    SLURM_ACCOUNT: "csstaff"
    FIRECREST_SYSTEM: "santis"
  before_script:
    - pwd
    - uname -a
    - ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
    - source ./uenv-4.0.1/bin/activate-uenv
    - uenv --version
    # - uenv image repo $SCRATCH/.uenv-images
    - imgs=$(./ci/scripts/alps_uenv.sh uenv_image_find)
  script: |
    echo "imgs=$imgs"
    export PATH=$PWD:$PATH
    uenv --version
    export PATH=$UENV_PREFIX/libexec:$PATH
    uenv-oras version
    for img in $imgs; do
      echo "----- Pulling img=$img metadata & sqfs"
      pwd
      # ./ci/scripts/alps_uenv.sh setup_jq
      # ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
      # source ./uenv-4.0.1/bin/activate-uenv
      # ./ci/scripts/alps_uenv.sh jfrog_login
      # img0=$(echo $imgs | cut -d" " -f1)
      # echo "img0=$img0"
      ./ci/scripts/alps_uenv.sh oras_pull_meta_dir "$img"
      #
      img_path=$(./ci/scripts/alps_uenv.sh uenv_sqfs_fullpath "$img")
      UENV+="$img_path,"
      echo
    done
    UENV=${UENV%?}
    echo "UENV=$UENV" | tr , "\n"
    echo "UENV=$UENV" > rfm_uenv.env
  artifacts:
    reports:
      dotenv: rfm_uenv.env

run reframe:
  stage: run
  tags: ["santis-login-baremetal"]
  # tags: ['f7t-runner']
  needs: ['setup and pull']
  variables:
    # Valid MODE=('container-runner', 'baremetal', 'f7t-controller')
    MODE: "f7t-controller"  # santis
    # MODE: "baremetal"  # eiger
    GIT_STRATEGY: "fetch"
    # SLURM_PARTITION: "debug"
    # SLURM_CONSTRAINT: "mc"
    F7T_TOKEN_URL: "https://auth.cscs.ch/auth/realms/firecrest-clients/protocol/openid-connect/token"
    F7T_URL: "https://firecrest.cscs.ch"
    SLURM_ACCOUNT: "csstaff"
    FIRECREST_SYSTEM: "santis"
  script:
    - echo "UENV=$UENV"
#   before_script:
#     - ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
#     - source ./uenv-4.0.1/bin/activate-uenv
#     - uenv --version
#     - imgs=$(./ci/scripts/alps_uenv.sh uenv_image_find)
#   script: |
#     rfm_path=$(./ci/scripts/alps_uenv.sh install_reframe)
#     export PATH=$PWD/reframe-4.5.2/bin:$PATH
#     for img in $imgs; do
#       echo "----- Testing img=$img"
#       echo "PWD=$PWD"
#       ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
#       source ./uenv-4.0.1/bin/activate-uenv
#       uenv image inspect $img
#       echo "----------------------"
#       img_path=$(./ci/scripts/alps_uenv.sh uenv_sqfs_fullpath "$img")
#       echo "img_path=$img_path"
#       ./ci/scripts/alps_uenv.sh launch_reframe "$img_path"
#     done
