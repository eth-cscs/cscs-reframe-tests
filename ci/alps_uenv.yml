include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - run
  - notify

reframe:
  stage: run
  extends: .f7t-baremetal-runner
  timeout: 8 hours
  # needs: ['setup and pull']
  rules:
    - if: '$BENCHER_API_TOKEN == null'
      variables:
        SLURM_TIMELIMIT: '02:00:00'
    - if: '$BENCHER_API_TOKEN'
      variables:
        SLURM_TIMELIMIT: '01:00:00'
  before_script:
    - echo "FIRECREST_SYSTEM=$FIRECREST_SYSTEM / F7T_URL=$F7T_URL / CLUSTER_NAME=$CLUSTER_NAME"
    - uname -a
    - pwd
    - uenv --version
    # - echo "UENV=$UENV" | tr , "\n"
    # Send data to elastic on main branch only
    - '[ "$CI_COMMIT_REF_NAME" != "main" ] && unset RFM_HTTPJSON_URL'
    - 'git remote add oripr https://github.com/eth-cscs/cscs-reframe-tests || true'
    - 'echo "it is safe to ignore error: remote already exists"'
    - git remote -v
    - hostname
  script:
    - 'imgs=$(./ci/scripts/alps.sh uenv_image_find)'
    - echo "imgs=$imgs"
    # ----------------------
    - unset UENVA
    - uenv repo status
    - for img in $imgs; do
        ./ci/scripts/alps.sh uenv_pull_meta_dir "$img" &> .rc;
        cat .rc;
        rc=$(grep -q OK .rc ; echo $?);
        echo "rc=$rc";
        if [ $rc -eq 0 ] ; then
          UENVA+="$img,";
          echo "UENVA=$UENVA";
        fi;
      done;
    - UENVA=${UENVA%?}
    - UENV=`echo ${UENVA} | sed 's-,,-,-g' | sort -u`
    - echo "UENV=$UENV"
    # ----------------------
    - rfm_path=$(./ci/scripts/alps.sh install_reframe |grep HERE |awk '{print $1}')
    - export PATH=$rfm_path:$PATH
    - reframe -V
    # ----------------------
    # If in a PR, run only the tests modified in the PR, else: in CRONJOB
    - |
      if [ "$CRON_RUN" = "true" ]; then
        if [ -z "${BENCHER_API_TOKEN+x}" ]; then
          ./ci/scripts/alps.sh launch_reframe_1arg "--mode daily_production" ;
        else
          ./ci/scripts/alps.sh launch_reframe_bencher ;
        fi
      else
        git fetch oripr main;
        git diff --name-only oripr/main...;
        tests_pr=$(git diff --name-only oripr/main... |grep checks |grep py$ |awk '{printf "-c %s ",$0}');
        if [ -z "$tests_pr" ]; then
          echo "no new/modified test(s) found, exiting";
          exit 0
        else
          echo "tests_pr=$tests_pr";
          ./ci/scripts/alps.sh launch_reframe_1arg "$tests_pr";
        fi
      fi
  artifacts:
    when: always
    paths:
      - reframe.out
      - report.xml
      - latest.json
    reports:
      junit: report.xml

# status_page:
#   stage: status
#   needs: ['reframe']
#   extends: .container-runner-lightweight-zen2
#   image: python:3.9
#   script:
#     - pwd
#     - ls -a
#     - pip install requests
#     - ./ci/scripts/alps.sh oneuptime "$FIRECREST_SYSTEM" "uenv"
#   when: always

notify_slack:
  stage: notify
  needs: ['reframe']
  extends: .container-runner-lightweight-zen2
  image: python:3.9
  script:
    - pwd
    - ls -a
    - pip install requests
    - python ./ci/scripts/slack_notify.py latest.json uenv
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: always
    - when: never
