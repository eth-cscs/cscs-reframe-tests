---
# TODO: https://github.com/finkandreas/benchpark/blob/develop/.ci/cscs.yml
include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - pull
  - run

variables:
  WORKSPACE: '$${CI_CACHE_FOLDER}/rfm_workspace'
  JOB_NAME: rfm-$CI_PIPELINE_ID
  CLUSTER_NAME: "${CLUSTER_NAME}"
  F7T_TOKEN_URL: 'https://auth.cscs.ch/auth/realms/firecrest-clients/protocol/openid-connect/token'
  F7T_URL: 'https://firecrest.cscs.ch'

setup and pull:
  stage: pull
  tags: ["$TAG"]
  # tags: ['f7t-runner']
  # tags: ["santis-spack-stack-builder"]
  variables:
    # Valid MODE=('container-runner', 'baremetal', 'f7t-controller')
    MODE: "${RFM_MODE}"
    # no runner match tags:eiger-login-baremetal
    # MODE: "f7t-controller"
    # SLURM_PARTITION: "${SLURM_PARTITION}"
    # SLURM_CONSTRAINT: "mc"
    GIT_STRATEGY: "fetch"
    SLURM_ACCOUNT: "csstaff"
    FIRECREST_SYSTEM: "${FIRECREST_SYSTEM}"
  before_script:
    - echo $FIRECREST_SYSTEM / $CLUSTER_NAME / $RFM_MODE
    - pwd
    - uname -a
    - ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
    - source ./uenv-5.0.0/bin/activate-uenv
    - uenv --version
    - export PATH=$PWD:$UENV_PREFIX/libexec:$PATH
    - uenv-oras version
    # - uenv image repo $SCRATCH/.uenv-images
    - imgs=$(./ci/scripts/alps_uenv.sh uenv_image_find)
  script: |
    # if [ "${CLUSTER_NAME}" == "eiger" ] ; then export SLURM_CONSTRAINT="mc"; fi
    echo "imgs=$imgs"
    # imgs='prgenv-gnu/24.7:v1 prgenv-gnu/23.11:latest cp2k/2024.1:v1'
    # export PATH=$PWD:$PATH
    # export PATH=$UENV_PREFIX/libexec:$PATH
    # echo $PATH | tr : "\n"
    # get list of uenv to test and set $UENV
    unset UENVA
    for img in $imgs; do
      ./ci/scripts/alps_uenv.sh oras_pull_meta_dir "$img"
      ./ci/scripts/alps_uenv.sh meta_has_reframe_yaml "$img" &> .rc
      grep -q OK .rc
      if [ $? -eq 0 ] ; then
        #echo UENVA=$UENVA rc=$rc
        UENVA+="$img,"
      fi
    done
    UENV=$(./ci/scripts/alps_uenv.sh remove_last_comma_from_variable "$UENVA")
    #UENVA=${UENVA%?}
    #UENV=`echo ${UENVA} | sed 's-,,-,-g' | sort -u`
    echo "UENV=$UENV" > rfm_uenv.env
    cat rfm_uenv.env | tr , "\n"
  artifacts:
    reports:
      dotenv: rfm_uenv.env

run reframe:
  stage: run
  # tags: ["santis-login-baremetal"]
  tags: ["$TAG"]
  # tags: ['f7t-runner']
  needs: ['setup and pull']
  variables:
    # Valid MODE=('container-runner', 'baremetal', 'f7t-controller')
    MODE: "${RFM_MODE}"
    # MODE: "f7t-controller"  # santis
    # MODE: "baremetal"  # eiger
    GIT_STRATEGY: "fetch"
    SLURM_ACCOUNT: "csstaff"
    FIRECREST_SYSTEM: "${FIRECREST_SYSTEM}"
    # SLURM_PARTITION: "${SLURM_PARTITION}"
    # SLURM_PARTITION: "debug"
    # SLURM_CONSTRAINT: "mc"
    # FIRECREST_SYSTEM: "santis"
  before_script:
    - echo $FIRECREST_SYSTEM / $CLUSTER_NAME / $RFM_MODE
    - pwd
    - uname -a
    - ./ci/scripts/alps_uenv.sh setup_uenv_and_oras &> setup_uenv_and_oras.log
    - source ./uenv-5.0.0/bin/activate-uenv
    - uenv --version
    - echo "UENV=$UENV" | tr , "\n"
  script:
    - rfm_path=$(./ci/scripts/alps_uenv.sh install_reframe)
    - echo "rfm_path=$rfm_path"
    - export PATH=$rfm_path:$PATH
    - reframe -V
    - ./ci/scripts/alps_uenv.sh launch_reframe
  artifacts:
    when: on_failure
    paths:
      - report.xml
    reports:
      junit: report.xml
